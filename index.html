<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <picture></picture>
  </header>
  <main>
    <label class="theme-toggle" for="theme-switch" aria-label="Toggle dark / light mode">
      <input type="checkbox" id="theme-switch" disabled>
      <span class="theme-toggle__icon theme-toggle__icon--sun">☀</span>
      <span class="theme-toggle__track"></span>
      <span class="theme-toggle__icon theme-toggle__icon--moon">☽</span>
    </label>
  </main>
  <aside>
    <canvas width="1024" height="512"></canvas>
  </aside>
  <footer></footer>

  <script src="bg.js"></script>
  <script>
    /**
     * Theme detection & toggle.
     * Runs after bg.js so the MutationObserver is already watching <html>.
     * Changing the class triggers a smooth 5-second colour transition in the
     * canvas renderer.
     */
    (function () {
      var loaded = false;
      let activated = false;
      var toggle = document.getElementById("theme-switch");
      var html = document.documentElement;
      var main = document.querySelector("main");
      var footer = document.querySelector("footer");
      var btn = document.createElement("button");

      function activate() {
        if (!activated) {
          activated = true;
          toggle.checked = mq.matches;
          toggle.disabled = false;
          applyTheme(mq.matches);
          btn.removeEventListener('click', activate);
          btn.addEventListener("click", deactivate);
          btn.textContent = "Close";

          setTimeout(function () {
            html.classList.add("activated");
          }, 400);
        }
      }

      function deactivate() {
        if (activated) {
          activated = false;
          html.classList.remove("theme-dark", "theme-light", "activated");
          btn.removeEventListener("click", deactivate);
          btn.addEventListener("click", activate);
          btn.textContent = "Say hi!";
        }
      }

      function applyTheme(dark) {
        html.classList.remove("theme-dark", "theme-light");
        html.classList.add(dark ? "theme-dark" : "theme-light");
      }

      function load() {
        if (!loaded) {
          loaded = true;
          btn.textContent = "Say hi!";
          btn.classList.add("btn");
          btn.addEventListener("click", activate);
          footer.appendChild(btn);

          setTimeout(function () {
            html.classList.add("loaded");
          }, 400);
        }
      }

      /* OS preference */
      var mq = window.matchMedia("(prefers-color-scheme: dark)");

      /* Manual toggle */
      toggle.addEventListener("change", function () {
        applyTheme(toggle.checked);
      });

      /* React to OS preference changes in real time */
      mq.addEventListener("change", function (e) {
        toggle.checked = e.matches;
        applyTheme(e.matches);
      });

      load();
    })();
  </script>
</body>

</html>